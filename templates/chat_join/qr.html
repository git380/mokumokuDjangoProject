{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>QRèª­ã¿è¾¼ã¿</title>
    <link rel="stylesheet" href="{% static 'chat_join/qr/style.css' %}">
</head>
<body>
<header>
    <a href="{% url 'home' %}"><i class="bi bi-house"></i></a>
</header>

<!--ã‚«ãƒ¡ãƒ©-->
<div id="loading">ğŸ“± ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</div>
<!-- ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ã§QRã‚³ãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹ãŸã‚ã®æº–å‚™ -->
<canvas id="canvas" hidden=""></canvas>


<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
    // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã® video è¦ç´ ã‚’ä½œæˆ
    const video = document.createElement('video');
    // ã‚­ãƒ£ãƒ³ãƒã‚¹è¦ç´ ã¨ãã® 2D ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    const canvasElement = document.getElementById('canvas');
    const canvas = canvasElement.getContext('2d');
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const loading = document.getElementById('loading');
    // QR ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒ•ãƒ©ã‚°ã®åˆæœŸåŒ–
    let isReadQR = false;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚’æ±‚ã‚ã€æˆåŠŸæ™‚ã«ã‚«ãƒ¡ãƒ©ã®æ˜ åƒã‚’å–å¾—ã—ã€æ˜ åƒã‚’è¡¨ç¤ºã—ã¦ QR ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ãŸã‚ã®å‡¦ç†
    navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}})
        .then((stream) => {
            // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒã‚’ video è¦ç´ ã«ã‚»ãƒƒãƒˆã—ã€å†ç”Ÿã‚’é–‹å§‹
            video.srcObject = stream;
            video.setAttribute('playsinline', true);
            video.play();
            // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
            requestAnimationFrame(tick);
        });

    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—é–¢æ•°(æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«å®Ÿè¡Œã•ã‚Œã‚‹)
    function tick() {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
        loading.textContent = 'âŒ› ãƒ­ãƒ¼ãƒ‰ä¸­...';

        // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            loading.hidden = true; // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            canvasElement.hidden = false; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è¡¨ç¤º
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ã‚«ãƒ¡ãƒ©æ˜ åƒã«åˆã‚ã›ã‚‹
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;

            // ã‚«ãƒ¡ãƒ©ã®æ˜ åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            // jsQR ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ QR ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹
            const code = jsQR(imageData.data, imageData.width, imageData.height, {inversionAttempts: 'dontInvert'});
            // QR ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã€ã¾ã èª­ã¿å–ã£ã¦ã„ãªã„å ´åˆ
            if (code && !isReadQR) {
                // QR ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã«åŸºã¥ã„ã¦ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                location.href = code.data;
                isReadQR = true; // èª­ã¿å–ã‚Šãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
            }
        }
        requestAnimationFrame(tick); // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã«é€²ã‚€
    }
</script>
</body>
</html>